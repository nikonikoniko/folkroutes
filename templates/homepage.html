  {% extends 'base.html' %}

{% block headscripts %}

<script src="//d3js.org/d3.v3.min.js"></script>

<style type="text/css">



.link {
  stroke: #999;
}

.node {
  fill: #fff;
  stroke: #fff;
}

text{
  color:#888;
}
html,body{
  height:100%;
}

viz{
  position:fixed;
  width:100%;
  height:100%;
  top:0;
  z-index:1;
}




</style>

{%  endblock %}

{% block main %}







<viz id="viz">

</viz>


<!--



=======================================
-->






<script type="text/javascript">

nids = [
{"num":0,"name":"Folkroutes","charge":1000}
    {% for item in floatsam %}
        ,{
          "num":{{item.floatsam_id}},
          "name":"{{item.name}}",
          "charge":{{item.charge}},
        }
    {% endfor %}
  ]
var graph = {
  nodes: nids,
  links: [
    {% for item in floatsam %}
      {% for thing in item.peers  %}
        {source:  {{item.floatsam_id}}, target:  {{thing.floatsam_id}}},
      {% endfor %}
    {% endfor %}


  ]
};

console.log(d3.range(13));
console.log(d3.range(13).map(Object));
console.log(graph.nodes);

var width = document.getElementById("viz").offsetWidth,
    height = document.getElementById("viz").offsetHeight;

    console.log(width);
    console.log(height);

var svg = d3.select("viz").append("svg")
    .attr("width", width)
    .attr("height", height);

var force = d3.layout.force()
    .size([width, height])
    .friction(.9)
    .linkStrength(0.3)
    .charge(function(d){
      console.log(d.charge);
      return d.charge;
      })
    .gravity(.3)
    .theta(0.8)
    .alpha(0.1)
    .on("tick", tick);





  var gnodes = svg.selectAll('g.gnode')
     .data(graph.nodes)
     .enter()
     .append('g')
     .classed('gnode', true)
     .on('mouseover', function(d){
        var nodeSelection = d3.select(this).style({opacity:'0.8'});
        nodeSelection.select("text").style({opacity:'1.0'});
      })
     .on('mouseout', function(d){
        var nodeSelection = d3.select(this).style({opacity:'1.0'});
        nodeSelection.select("text").style({opacity:'0.0'});
      });


  var link = svg.selectAll(".link")
      .data(graph.links)
      .enter()
      .append("line")
      .attr("class", "link")
      .style("stroke-width", function(d) { return Math.sqrt(d.value); });

  var node = gnodes.append("circle")
      .attr("class", "node")
      .attr("r", 1.5)
      .style("fill", function(d) { return "#fff" });

  var labels = gnodes.append("text")
      .text(function(d) { return d.name; })
      .style('fill', 'black')
      .style("font-size", "12px")
      .style({opacity:'0.7'});


var drawGraph = function(graph) {



  force
      .nodes(graph.nodes)
      .links(graph.links)
      .start();

}


drawGraph(graph);







var zoom = d3.behavior.zoom().scaleExtent([.1,7])

var nominal_base_node_size = 8;
var nominal_text_size = 10;
var max_text_size = 24;
var nominal_stroke = 1.5;
var max_stroke = 4.5;
var max_base_node_size = 36;
var text_center=true;

zoom.on("zoom", function() {

    var stroke = nominal_stroke;
    if (nominal_stroke*zoom.scale()>max_stroke) stroke = max_stroke/zoom.scale();
    link.style("stroke-width",stroke);
    //circle.style("stroke-width",stroke);

  var base_radius = nominal_base_node_size;
    if (nominal_base_node_size*zoom.scale()>max_base_node_size) base_radius = max_base_node_size/zoom.scale();
        //circle.attr("d", d3.svg.symbol()
        //.size(function(d) { return Math.PI*Math.pow(size(d.size)*base_radius/nominal_base_node_size||base_radius,2); })
        //.type(function(d) { return d.type; }))

  //circle.attr("r", function(d) { return (size(d.size)*base_radius/nominal_base_node_size||base_radius); })
  if (!text_center) text.attr("dx", function(d) { return (size(d.size)*base_radius/nominal_base_node_size||base_radius); });

  var text_size = nominal_text_size;
    if (nominal_text_size*zoom.scale()>max_text_size) text_size = max_text_size/zoom.scale();
    labels.style("font-size",text_size + "px");

    console.log(d3.event.translate);

    node.attr("transform", "translate(" + [d3.event.translate[0],d3.event.translate[1]] + ")scale(" + (-1*d3.event.scale) + ")");
    link.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
    labels.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
  });


svg.call(zoom);













function tick() {
  link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    gnodes.attr("transform", function(d) {
        return 'translate(' + [d.x, d.y] + ')';
    });

    console.log("sup");
}

</script>

{% endblock %}