  {% extends 'base.html' %}

{% block headscripts %}

<script src="//d3js.org/d3.v3.min.js"></script>

<style type="text/css">



.link {
  stroke: #fff;
}

.node {
  fill: #fff;
  stroke: #fff;
}

text{
  color:#888;
}
html,body{
  height:100%;
}

viz{
  position:fixed;
  width:100%;
  height:100%;
  top:0;
  z-index:1;
}




</style>

{%  endblock %}

{% block main %}







<viz id="viz">

</viz>


<!--



=======================================
-->






<script type="text/javascript">

nids = [
{"num":0,"name":"Folkroutes","charge":1000}
    {% for item in floatsam %}
        ,{
          "num":{{item.floatsam_id}},
          "name":"{{item.name}}",
          "url":"/floatsam/{{item.floatsam_id}}",
          "charge":{{item.charge}},
        }
    {% endfor %}
  ]
var graph = {
  nodes: nids,
  links: [
    {% for item in floatsam %}
      {% for thing in item.peers  %}
        {source:  {{item.floatsam_id}}, target:  {{thing.floatsam_id}}},
      {% endfor %}
    {% endfor %}


  ]
};

console.log(d3.range(13));
console.log(d3.range(13).map(Object));
console.log(graph.nodes);

var width = document.getElementById("viz").offsetWidth,
    height = document.getElementById("viz").offsetHeight;



 var t0 = Date.now();
var state_rotate = 90 + t0 * 1/200;
var state_translate = [0,0]
var state_scale = 1

    console.log(width);
    console.log(height);

var svg = d3.select("viz").append("svg:svg")
    .attr("width", width)
    .attr("height", height)
    .call(d3.behavior.zoom().scaleExtent([1, 10]).on("zoom", redraw))
    .attr("pointer-events", "all")
  .append('svg:g')
    .call(d3.behavior.zoom().on("zoom", redraw))
  .append('svg:g');;



var force = d3.layout.force()
    .size([width, height])
    .friction(.9)
    .linkStrength(0.3)
    .charge(function(d){
      console.log(d.charge);
      return d.charge;
      })
    .gravity(.3)
    .theta(0.8)
    .alpha(0.1)
    .on("tick", tick);





  var gnodes = svg.selectAll('g.gnode')
     .data(graph.nodes)
     .enter()
     .append('g')
     .classed('gnode', true)
     .on('mouseover', function(d){
        var nodeSelection = d3.select(this).style({opacity:'0.8'});
        nodeSelection.select("text").style({opacity:'1.0'});
      })
     .on('mouseout', function(d){
        var nodeSelection = d3.select(this).style({opacity:'1.0'});
        nodeSelection.select("text").style({opacity:'0.1'});
      });


  var link = svg.selectAll(".link")
      .data(graph.links)
      .enter()
      .append("line")
      .attr("class", "link")
      .style("stroke-width", .2);


    var node = gnodes.append("circle")
      .attr("class", "node")
      .attr("r", 1.5)
      .style("fill", function(d) { return "#fff" });

  var labels = gnodes.append("text")
      .text(function(d) { return d.name; })
      .style('fill', 'black')
      .style("font-size", "8px")
      .style({opacity:'0.1'})
      .on("click",function(d){
        window.location = d.url})
      .style("cursor","pointer");


var drawGraph = function(graph) {



  force
      .nodes(graph.nodes)
      .links(graph.links)
      .start();

}


drawGraph(graph);









function redraw() {

  state_translate = d3.event.translate;
  state_scale = d3.event.scale;
  svg.attr("transform",
      "translate(" + d3.event.translate + ")"
      + " scale(" + d3.event.scale + ")"
      + " rotate(" + state_rotate + "," + width/2 +"," + height/2 +")"
      );
}











function tick() {
  link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    gnodes.attr("transform", function(d) {
        return 'translate(' + [d.x, d.y] + ')';
    });

    console.log("sup");
}











  d3.timer(function() {
    console.log("hhiieeerr");
    var delta = (Date.now() - t0);

    console.log("rotate(" + state_rotate + "," + width/2 +"," + height/2 +")"
    + " translate(" + state_translate + ")"
      + " scale(" + state_scale + ")");
    state_rotate = 90 + delta * 1/200;

    svg.attr("transform", "rotate(" + state_rotate + "," + width/2 +"," + height/2 +")"
    + " translate(" + state_translate + ")"
      + " scale(" + state_scale + ")"
    );
  });

</script>

{% endblock %}